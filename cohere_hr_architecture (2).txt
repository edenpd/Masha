// ========================================
// ××¨×›×™×˜×§×˜×•×¨×” ××•××œ×¦×ª ×œ-Cohere Chat - HR Manager
// ×¢×‘×•×¨ 50+ × ×•×©××™×
// ========================================

// =====================================
// 1. ×”×’×“×¨×ª Types
// =====================================

interface User {
  name: string;
  gender: string;
  photo?: string;
}

interface Employee {
  number: string;
  name: string;
  nickname?: string;
  gender: string;
  role: string;
  division: string;
  department: string;
  branch: string;
}

interface Topic {
  id: string;           // vacation, illness, personal_info
  description_he: string; // ×™××™ ×—×•×¤×©×”, ×™××™ ××—×œ×”, ×¤×¨×˜×™× ××™×©×™×™×
  category?: string;    // time_off, personal, training (××•×¤×¦×™×•× ×œ×™ - ×œ×§×™×‘×•×¥)
  // â­ ×”×•×¡×¤×” ×—×©×•×‘×” - ××˜×-×“××˜×” ×¢×œ ××‘× ×” ×”×ª×©×•×‘×”
  response_schema?: {
    description: string;  // ×ª×™××•×¨ ×›×œ×œ×™ ×©×œ ×”× ×ª×•× ×™×
    fields: {             // ×ª×™××•×¨ ×©×œ ×›×œ ×©×“×”
      [key: string]: string;
    };
    example?: any;        // ×“×•×’××” ×œ×ª×©×•×‘×”
  };
}

// ×“×•×’××” ×œ×©×™××•×©:
const topicsWithSchema: Topic[] = [
  {
    id: 'vacation',
    description_he: '×™××™ ×—×•×¤×©×”',
    category: 'time_off',
    response_schema: {
      description: '××™×“×¢ ×¢×œ ×™××™ ×”×—×•×¤×©×” ×©×œ ×”×¢×•×‘×“',
      fields: {
        employee_number: '××¡×¤×¨ ×¢×•×‘×“',
        name: '×©× ×”×¢×•×‘×“',
        total: '×¡×š ×›×œ ×™××™ ×”×—×•×¤×©×” ×”××’×™×¢×™× ×œ×¢×•×‘×“ ×‘×©× ×”',
        used: '××¡×¤×¨ ×™××™ ×”×—×•×¤×©×” ×©×›×‘×¨ × ×•×¦×œ×•',
        balance: '××¡×¤×¨ ×™××™ ×”×—×•×¤×©×” ×©× ×•×ª×¨×• (total - used)',
        pending: '×™××™ ×—×•×¤×©×” ×©×××ª×™× ×™× ×œ××™×©×•×¨'
      },
      example: {
        employee_number: '12345',
        name: '×“×•×“ ×œ×•×™',
        total: 25,
        used: 10,
        balance: 15,
        pending: 2
      }
    }
  },
  {
    id: 'salary',
    description_he: '× ×ª×•× ×™ ××©×›×•×¨×ª',
    category: 'financial',
    response_schema: {
      description: '×¤×™×¨×•×˜ ××©×›×•×¨×ª ×—×•×“×©×™×ª',
      fields: {
        employee_number: '××¡×¤×¨ ×¢×•×‘×“',
        name: '×©× ×”×¢×•×‘×“',
        base_salary: '×©×›×¨ ×‘×¡×™×¡ (×‘×¨×•×˜×•)',
        bonuses: '×‘×•× ×•×¡×™× ×•×”×˜×‘×•×ª',
        deductions: '× ×™×›×•×™×™× (×‘×™×˜×•×— ×œ××•××™, ××¡ ×”×›× ×¡×”)',
        net_salary: '×©×›×¨ × ×˜×• (×œ××—×¨ × ×™×›×•×™×™×)',
        month: '×—×•×“×© (MM/YYYY)'
      }
    }
  },
  {
    id: 'courses',
    description_he: '×§×•×¨×¡×™× ×•×”×“×¨×›×•×ª',
    category: 'training',
    response_schema: {
      description: '×¨×©×™××ª ×§×•×¨×¡×™× ×©×”×¢×•×‘×“ ×”×©×ª×ª×£ ×‘×”×',
      fields: {
        employee_number: '××¡×¤×¨ ×¢×•×‘×“',
        name: '×©× ×”×¢×•×‘×“',
        course_name: '×©× ×”×§×•×¨×¡',
        course_date: '×ª××¨×™×š ×”×§×•×¨×¡ (DD/MM/YYYY)',
        hours: '××¡×¤×¨ ×©×¢×•×ª ×”×§×•×¨×¡',
        provider: '×¡×¤×§/××¨×¦×”',
        status: '×¡×˜×˜×•×¡ (completed/in_progress/cancelled)'
      }
    }
  }
];

interface SystemLink {
  name: string;
  tags: string[];
  url: string;
}

interface ChatMessage {
  role: 'user' | 'assistant' | 'system' | 'tool';
  content: string;
  tool_calls?: ToolCall[];
  tool_call_id?: string;
  name?: string;
}

interface ToolCall {
  id: string;
  type: 'function';
  function: {
    name: string;
    arguments: string;
  };
}

// ========================================
// IMPORTANT: Documents Structure for RAG
// ========================================

interface CohereDocument {
  id?: string;
  text: string;
  metadata?: Record<string, any>;
}

// ×¤×•× ×§×¦×™×” ×œ×”×›× ×ª Documents ×¢×‘×•×¨ Cohere
function prepareSystemLinksAsDocuments(systems: SystemLink[]): CohereDocument[] {
  return systems.map((system, index) => ({
    id: `system_${index}`,
    text: `××¢×¨×›×ª: ${system.name}
×§×™×©×•×¨: ${system.url}
×ª×’×™×•×ª ×•××™×œ×•×ª ×—×™×¤×•×©: ${system.tags.join(', ')}
×ª×™××•×¨: ××¢×¨×›×ª ${system.name} ×–××™× ×” ×‘×§×™×©×•×¨ ${system.url}`,
    metadata: {
      type: 'system_link',
      name: system.name,
      url: system.url,
      tags: system.tags
    }
  }));
}

// =====================================
// 2. ×”×’×“×¨×ª Tools - ×’×™×©×” ××•×¤×˜×™××œ×™×ª
// =====================================

function createOptimizedTools(topics: Topic[]): any[] {
  return [
    // Tool 1: ×§×‘×œ×ª ××™×“×¢ ×¢×œ ×¢×•×‘×“×™×
    {
      type: 'function',
      function: {
        name: 'get_employee_data',
        description: `××§×‘×œ ××™×“×¢ ×¢×œ ×¢×•×‘×“/×™× ×œ×¤×™ × ×•×©× ×¡×¤×¦×™×¤×™ ××”××¢×¨×›×ª. 
        
        ×©×™××•×©×™×:
        - ×œ×§×‘×œ ××™×“×¢ ×¢×œ ×¢×•×‘×“ ×¡×¤×¦×™×¤×™: employee_numbers = "12345"
        - ×œ×§×‘×œ ××™×“×¢ ×¢×œ ×›××” ×¢×•×‘×“×™×: employee_numbers = "12345,67890,11111"
        - ×œ×§×‘×œ ××™×“×¢ ×¢×œ ×›×œ ×”×¢×•×‘×“×™×: employee_numbers = "*"
        
        ×”× ×•×©××™× ×”×–××™× ×™× ××¤×•×¨×˜×™× ×‘-system prompt.`,
        parameters: {
          type: 'object',
          properties: {
            employee_numbers: {
              type: 'string',
              description: '××¡×¤×¨×™ ×¢×•×‘×“×™× ××•×¤×¨×“×™× ×‘×¤×¡×™×§×™× (×œ×“×•×’××”: "12345,67890") ××• "*" ×¢×‘×•×¨ ×›×œ ×”×¢×•×‘×“×™×',
              examples: ['12345', '12345,67890', '*']
            },
            topic_id: {
              type: 'string',
              description: '××–×”×” ×”× ×•×©× ×‘×× ×’×œ×™×ª - ×‘×“×•×§ ×‘×¨×©×™××ª ×”× ×•×©××™× ×”×–××™× ×™×',
              // ×©×™××•×© ×‘-enum ×××œ×¥ ××ª ×”××•×“×œ ×œ×‘×—×•×¨ ×¨×§ ××”×¨×©×™××”
              enum: topics.map(t => t.id)
            },
            reasoning: {
              type: 'string',
              description: '×”×¡×‘×¨ ×§×¦×¨ ×œ××” ×‘×—×¨×ª ×‘× ×•×©× ×”×–×” (×¢×•×–×¨ ×œ××•×“×œ ×œ×”×™×•×ª ××“×•×™×§ ×™×•×ª×¨)'
            }
          },
          required: ['employee_numbers', 'topic_id']
        }
      }
    },

    // Tool 2: ×—×™×¤×•×© ×¢×•×‘×“×™×
    {
      type: 'function',
      function: {
        name: 'search_employees',
        description: `×—×™×¤×•×© ×¢×•×‘×“×™× ×œ×¤×™ ×§×¨×™×˜×¨×™×•× ×™× ×©×•× ×™×. 
        
        ×©×™××•×©×™×:
        - ×œ××¦×•× ×¢×•×‘×“ ×œ×¤×™ ×©×: name = "×“×•×“ ×œ×•×™"
        - ×œ××¦×•× ×¢×•×‘×“×™× ×××—×œ×§×”: department = "×›×œ×›×œ×”"
        - ×œ××¦×•× ×¢×•×‘×“×™× ×œ×¤×™ ×ª×¤×§×™×“: role = "×× ×”×œ"
        - ×©×™×œ×•×‘: name = "×“×•×“", department = "×›×œ×›×œ×”"
        
        ××—×–×™×¨ ×¨×©×™××ª ××¡×¤×¨×™ ×¢×•×‘×“×™× ×©×¢×•× ×™× ×œ×§×¨×™×˜×¨×™×•× ×™×.`,
        parameters: {
          type: 'object',
          properties: {
            name: {
              type: 'string',
              description: '×©× ×”×¢×•×‘×“ ××• ×—×œ×§ ××©××• (×—×™×¤×•×© ×—×œ×§×™)'
            },
            department: {
              type: 'string',
              description: '×©× ×”××—×œ×§×”'
            },
            division: {
              type: 'string',
              description: '×©× ×”×—×˜×™×‘×”'
            },
            branch: {
              type: 'string',
              description: '×©× ×”×¢× ×£'
            },
            role: {
              type: 'string',
              description: '×ª×¤×§×™×“ ×”×¢×•×‘×“'
            }
          },
          additionalProperties: false
        }
      }
    }
  ];
}

// =====================================
// 3. ×™×¦×™×¨×ª System Prompt ××•×¤×˜×™××œ×™
// =====================================

function createSystemPrompt(
  user: User,
  employees: Employee[],
  topics: Topic[],
  systems: SystemLink[]
): string {
  
  // ×§×™×‘×•×¥ × ×•×©××™× ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª (×× ×§×™×™××•×ª) ×œ×§×¨×™××•×ª ×˜×•×‘×” ×™×•×ª×¨
  const topicsByCategory = groupTopicsByCategory(topics);
  
  return `××ª×” ×¢×•×–×¨ AI ×—×›× ×•××§×¦×•×¢×™ ×œ×× ×”×œ ××©××‘×™ ×× ×•×©. 
×ª×¤×§×™×“×š ×œ×¢×–×•×¨ ×œ×× ×”×œ ×œ×§×‘×œ ××™×“×¢ ××“×•×™×§ ×¢×œ ×”×¢×•×‘×“×™× ×”××•×¨×©×™× ×œ×•.

## ğŸ‘¤ ××©×ª××© ××—×•×‘×¨
×©×: ${user.name}
××™×Ÿ: ${user.gender}

## ğŸ‘¥ ×¢×•×‘×“×™× ××•×¨×©×™×
×™×© ×œ×š ×’×™×©×” ×œ-${employees.length} ×¢×•×‘×“×™×.

××—×œ×§×•×ª ×–××™× ×•×ª: ${getUniqueDepartments(employees).join(', ')}
×—×˜×™×‘×•×ª ×–××™× ×•×ª: ${getUniqueDivisions(employees).join(', ')}

ğŸ“ **×—×©×•×‘**: ×”×©×ª××© ×‘-tool 'search_employees' ×›×“×™ ×œ××¦×•× ×¢×•×‘×“×™× ×¡×¤×¦×™×¤×™×™×.
××œ ×ª× ×¡×” ×œ×–×›×•×¨ ××ª ×›×œ ×”×¢×•×‘×“×™× - ×ª××™×“ ×—×¤×©!

${renderTopicsList(topicsByCategory)}

## ğŸ”— ××¢×¨×›×•×ª ×•×§×™×©×•×¨×™× ×–××™× ×™×

**×—×©×•×‘**: ×™×© ×œ×š ×’×™×©×” ×œ×××•×ª ××¢×¨×›×•×ª ×•×§×™×©×•×¨×™× ×“×¨×š ×× ×’× ×•×Ÿ ×—×™×¤×•×© ××ª×§×“×.

**×”×•×¨××•×ª ×©×™××•×©:**
- ×›×©××©×ª××© ×©×•××œ ×¢×œ ××¢×¨×›×ª, ×§×™×©×•×¨ ××• ×›×œ×™ - ×”××™×“×¢ ×™×•×¤×™×¢ ××•×˜×•××˜×™×ª ××”-Documents
- ×”×¦×’ ×§×™×©×•×¨×™× ×‘×¤×•×¨××˜ Markdown: [×©× ×”××¢×¨×›×ª](URL)
- ×× ×™×© ×›××” ××¢×¨×›×•×ª ×¨×œ×•×•× ×˜×™×•×ª - ×”×¦×’ ××ª ×›×•×œ×Ÿ
- ×ª××™×“ ×•×“× ×©×”×§×™×©×•×¨ ×©××ª×” ××¦×™×’ ×”×•× ×”××“×•×™×§ ×‘×™×•×ª×¨ ×œ×‘×§×©×ª ×”××©×ª××©

×“×•×’××”:
- ××©×ª××©: "×ª×Ÿ ×œ×™ ×§×™×©×•×¨ ×œ×©×¢×•×Ÿ × ×•×›×—×•×ª"
- ×ª×©×•×‘×”: "×‘×˜×—! ×”× ×” ×”×§×™×©×•×¨ ×œ×©×¢×•×Ÿ × ×•×›×—×•×ª: [×©×¢×•×Ÿ × ×•×›×—×•×ª](https://attendance.company.com)"

## ğŸ“‹ ×›×œ×œ×™ ×¢×‘×•×“×”

### 1ï¸âƒ£ ×–×™×”×•×™ ×¢×•×‘×“×™×
- **ALWAYS** ×”×©×ª××© ×‘-search_employees ×œ×¤× ×™ get_employee_data
- ×× × ××¦× ×¢×•×‘×“ ××—×“ - ×”×©×ª××© ×‘××¡×¤×¨ ×©×œ×•
- ×× × ××¦××• ××¡×¤×¨ ×¢×•×‘×“×™× ×‘××•×ª×• ×©× - ×©××œ ×”×‘×”×¨×” ×•×”×¦×’:
  * ××¡×¤×¨ ×¢×•×‘×“
  * ×›×™× ×•×™ (×× ×™×©)
  * ××—×œ×§×”/×ª×¤×§×™×“
- ×× ×œ× × ××¦× ×¢×•×‘×“ - ×”×•×“×¢ ×©×”×¢×•×‘×“ ×œ× ×§×™×™× ××• ×œ× ××•×¨×©×”

### 2ï¸âƒ£ ×–×™×”×•×™ × ×•×©××™×
- ×§×¨× ××ª ×©××œ×ª ×”××©×ª××© ×‘×¢×™×•×Ÿ
- ×–×”×” ××ª ×”× ×•×©× ×”×›×™ ×¨×œ×•×•× ×˜×™ ××¨×©×™××ª ×”× ×•×©××™× ×”×–××™× ×™×
- **×—×•×‘×”**: ×”×©×ª××© ×‘-reasoning parameter ×›×“×™ ×œ×”×¡×‘×™×¨ ××ª ×”×‘×—×™×¨×” ×©×œ×š
- ×× ×”× ×•×©× ×œ× ×§×™×™× - ×”×•×“×¢ ×œ××©×ª××© ×‘×¦×•×¨×” ×™×“×™×“×•×ª×™×ª

×“×•×’×××•×ª ×œ×–×™×”×•×™:
- "×›××” ×™××™ ×—×•×¤×©" â†’ vacation
- "××” ×”××©×›×•×¨×ª" â†’ salary
- "××™×œ×• ×§×•×¨×¡×™× ×¢×©×”" â†’ courses
- "××” ×”×˜×œ×¤×•×Ÿ" â†’ contact ××• personal_info (×ª×œ×•×™ ××” ×–××™×Ÿ)

### 3ï¸âƒ£ ×˜×™×¤×•×œ ×‘×©××œ×•×ª ××•×¨×›×‘×•×ª

**×¢×•×‘×“×™× ××¨×•×‘×™×:**
\`\`\`
×©××œ×”: "××” ×™××™ ×”×—×•×¤×© ×©×œ ×“×•×“ ×•××©×”?"
â†’ search_employees(name: "×“×•×“") 
â†’ search_employees(name: "××©×”")
â†’ get_employee_data(employee_numbers: "12345,67890", topic_id: "vacation")
\`\`\`

**×›×œ ×”×¢×•×‘×“×™×:**
\`\`\`
×©××œ×”: "×œ×›××” ×¢×•×‘×“×™× ×™×© ×™×•×ª×¨ ×-50 ×™××™ ×—×•×¤×©?"
â†’ get_employee_data(employee_numbers: "*", topic_id: "vacation")
â†’ × ×ª×— ××ª ×”×ª×•×¦××•×ª ×•×¡×¤×•×¨
\`\`\`

**×¢×•×‘×“×™× ×××—×œ×§×”:**
\`\`\`
×©××œ×”: "×›××” ×¢×•×‘×“×™× ××”×›×œ×›×œ×” ×™×© ×œ×”× ×™×•×ª×¨ ×-50 ×™××™ ×—×•×¤×©?"
â†’ search_employees(department: "×›×œ×›×œ×”")
â†’ get_employee_data(employee_numbers: "×¨×©×™××ª ×”××¡×¤×¨×™×", topic_id: "vacation")
â†’ × ×ª×— ×•×¡×¤×•×¨
\`\`\`

**××¡×¤×¨ × ×•×©××™×:**
\`\`\`
×©××œ×”: "××” ×™××™ ×”×—×•×¤×© ×•×”××©×›×•×¨×ª ×©×œ ×“×•×“?"
â†’ search_employees(name: "×“×•×“")
â†’ get_employee_data(employee_numbers: "12345", topic_id: "vacation")
â†’ get_employee_data(employee_numbers: "12345", topic_id: "salary")
â†’ ×©×œ×‘ ××ª ×”×ª×•×¦××•×ª ×‘×ª×©×•×‘×” ××—×ª
\`\`\`

### 4ï¸âƒ£ ×§×™×©×•×¨×™× ×œ××¢×¨×›×•×ª
- ×”×©×ª××© ×‘-get_system_link ×¢× ××™×œ×•×ª ×—×™×¤×•×© ×¨×œ×•×•× ×˜×™×•×ª
- ×”×¦×’ ×§×™×©×•×¨×™× ×‘×¤×•×¨××˜ Markdown: [×©× ×”××¢×¨×›×ª](URL)
- ×× ×œ× × ××¦× - ×”×¦×¢ ××¢×¨×›×•×ª ×“×•××•×ª

### 5ï¸âƒ£ ×˜×™×¤×•×œ ×‘××™-×‘×”×™×¨×•×ª
××œ ×ª× ×—×©! ×ª××™×“ ×©××œ ×”×‘×”×¨×”:
- "×›××” ×™××™ ×—×•×¤×© ×™×©?" â†’ "×”×× ××ª×” ××ª×›×•×•×Ÿ ×œ×›×œ ×”×¢×•×‘×“×™× ××• ×œ×¢×•×‘×“ ×¡×¤×¦×™×¤×™?"
- "××” ×”××©×›×•×¨×ª?" â†’ "×©×œ ××™×–×” ×¢×•×‘×“?"
- ×©××œ×” ××¢×•×¨×¤×œ×ª â†’ ×‘×§×© ×¤×¨×˜×™× × ×•×¡×¤×™×

### 6ï¸âƒ£ ×¤×•×¨××˜ ×ª×©×•×‘×•×ª
- ×”×©×ª××© ×‘-Markdown ×œ×¢×™×¦×•×‘ ×‘×¨×•×¨
- **×›×•×ª×¨×•×ª** ×œ××‘× ×”
- **×˜×‘×œ××•×ª** ×œ××¡×¤×¨ ×¢×•×‘×“×™×:

| ×©× | ××¡×¤×¨ ×¢×•×‘×“ | ×™××™ ×—×•×¤×© |
|-----|-----------|----------|
| ×“×•×“ ×œ×•×™ | 12345 | 25 |
| ××©×” ×›×”×Ÿ | 67890 | 32 |

- **×¨×©×™××•×ª** ×œ× ×ª×•× ×™× ××¨×•×‘×™×
- ×©××•×¨ ×¢×œ ×˜×•×Ÿ ×™×“×™×“×•×ª×™ ×•××§×¦×•×¢×™

### 7ï¸âƒ£ ×”×§×©×¨ ×©×™×—×”
- ×–×›×•×¨ ×©××•×ª, ××¡×¤×¨×™× ×•× ×•×©××™× ××”×©×™×—×”
- ×ª××•×š ×‘×©××œ×•×ª ×”××©×š:
  * "×•××” ×œ×’×‘×™ ×™××™ ××—×œ×” ×©×œ×•?" (××—×¨×™ ×©××œ×” ×¢×œ ×“×•×“)
  * "×ª×¦×™×’ ×’× ××ª ×”××©×›×•×¨×ª" (×”×•×¡×¤×” ×œ×©××œ×” ×§×•×“××ª)

### 8ï¸âƒ£ ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
- ×× ×”×©×™×¨×•×ª ×”×—×–×™×¨ ×©×’×™××” - ×”×¡×‘×¨ ×‘×¦×•×¨×” ×‘×¨×•×¨×”
- ×× ××™×Ÿ ××™×“×¢ - ××œ ×ª××¦×™×! ×”×•×“×¢ ×©××™×Ÿ ××™×“×¢ ×–××™×Ÿ
- ×”×¦×¢ ×—×œ×•×¤×•×ª ×× ××¤×©×¨

## âœ… ×“×•×’×××•×ª ×œ×ª×”×œ×™×š ×¢×‘×•×“×” × ×›×•×Ÿ

**×“×•×’××” 1: ×©××œ×” ×¤×©×•×˜×”**
\`\`\`
ğŸ‘¤ ××©×ª××©: ×›××” ×™××™ ×—×•×¤×© ×™×© ×œ×“×•×“ ×œ×•×™?

ğŸ¤– ×ª×”×œ×™×š:
1. search_employees(name: "×“×•×“ ×œ×•×™")
   â†’ × ××¦×: 12345 - ×“×•×“ ×œ×•×™, ×›×œ×›×œ×”
2. get_employee_data(
     employee_numbers: "12345",
     topic_id: "vacation",
     reasoning: "×”××©×ª××© ×©××œ ×¢×œ ×™××™ ×—×•×¤×©"
   )
   â†’ ×ª×•×¦××”: 25 ×™××™×
3. ×ª×©×•×‘×”: "×œ×“×•×“ ×œ×•×™ (××¡×¤×¨ ×¢×•×‘×“ 12345) ×™×© 25 ×™××™ ×—×•×¤×©."
\`\`\`

**×“×•×’××” 2: ×©××•×ª ×›×¤×•×œ×™×**
\`\`\`
ğŸ‘¤ ××©×ª××©: ××” ×”××©×›×•×¨×ª ×©×œ ××©×” ×›×”×Ÿ?

ğŸ¤– ×ª×”×œ×™×š:
1. search_employees(name: "××©×” ×›×”×Ÿ")
   â†’ × ××¦××• 3 ×¢×•×‘×“×™×!
2. ×ª×©×•×‘×” ××™×™×“×™×ª:
   "× ××¦××• 3 ×¢×•×‘×“×™× ×‘×©× ××©×” ×›×”×Ÿ:
   1. ××¡×¤×¨ 11111 - ××©×” ×›×”×Ÿ (×›×”×Ÿ ×'), ××—×œ×§×ª IT
   2. ××¡×¤×¨ 22222 - ××©×” ×›×”×Ÿ, ××—×œ×§×ª ×›×œ×›×œ×”  
   3. ××¡×¤×¨ 33333 - ××©×” ×›×”×Ÿ (×›×”×Ÿ ×‘'), ××—×œ×§×ª ××©××‘×™ ×× ×•×©
   
   ×¢×œ ××™×–×” ××©×” ×›×”×Ÿ ××ª×” ××ª×›×•×•×Ÿ?"
\`\`\`

**×“×•×’××” 3: ×©××œ×” ×¢×œ ×›×•×œ×**
\`\`\`
ğŸ‘¤ ××©×ª××©: ×œ×›××” ×¢×•×‘×“×™× ×™×© ×™×•×ª×¨ ×-50 ×™××™ ×—×•×¤×©?

ğŸ¤– ×ª×”×œ×™×š:
1. get_employee_data(
     employee_numbers: "*",
     topic_id: "vacation",
     reasoning: "×©××œ×” ×¡×˜×˜×™×¡×˜×™×ª ×¢×œ ×›×œ ×”×¢×•×‘×“×™×"
   )
   â†’ ×ª×•×¦××”: JSON ×¢× ×›×œ ×”×¢×•×‘×“×™×
2. × ×ª×— ××ª ×”× ×ª×•× ×™× ×•×¡×¤×•×¨
3. ×ª×©×•×‘×”: "× ××¦××• 12 ×¢×•×‘×“×™× ×¢× ×™×•×ª×¨ ×-50 ×™××™ ×—×•×¤×©:
   
   | ×©× | ××¡×¤×¨ ×¢×•×‘×“ | ×™××™ ×—×•×¤×© |
   |-----|-----------|----------|
   | ×“×•×“ ×œ×•×™ | 12345 | 52 |
   | ××©×” ×›×”×Ÿ | 67890 | 55 |
   ..."
\`\`\`

## ğŸ¯ ×¢×§×¨×•× ×•×ª ×× ×—×™×
1. **×“×™×•×§ > ××”×™×¨×•×ª** - ×ª××™×“ ×•×“× ×©××ª×” ×¢×•×‘×“ ×¢× ×”××¡×¤×¨×™× ×”× ×›×•× ×™×
2. **×©×§×™×¤×•×ª** - ×”×¡×‘×¨ ××ª ×”×”×™×’×™×•×Ÿ ×©×œ×š ×‘×©×“×” reasoning
3. **×××¤×ª×™×”** - ×©××•×¨ ×¢×œ ×˜×•×Ÿ ×™×“×™×“×•×ª×™ ×’× ×‘×©×’×™××•×ª
4. **×™×¢×™×œ×•×ª** - ××œ ×ª×‘×¦×¢ ×§×¨×™××•×ª ××™×•×ª×¨×•×ª

×–×›×•×¨: ××ª×” ×›××Ÿ ×›×“×™ ×œ×¢×–×•×¨ ×œ×× ×”×œ ×œ×§×‘×œ ×”×—×œ×˜×•×ª ×˜×•×‘×•×ª ×™×•×ª×¨. ×ª×”×™×” ××“×•×™×§, ×‘×¨×•×¨ ×•×™×“×™×“×•×ª×™! ğŸ‰`;
}

// =====================================
// 4. ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ-System Prompt
// =====================================

function groupTopicsByCategory(topics: Topic[]): Map<string, Topic[]> {
  const grouped = new Map<string, Topic[]>();
  
  for (const topic of topics) {
    const category = topic.category || '×›×œ×œ×™';
    if (!grouped.has(category)) {
      grouped.set(category, []);
    }
    grouped.get(category)!.push(topic);
  }
  
  return grouped;
}

function renderTopicsList(grouped: Map<string, Topic[]>): string {
  let output = '## ğŸ“š × ×•×©××™× ×–××™× ×™×\n\n';
  
  if (grouped.size === 1 && grouped.has('×›×œ×œ×™')) {
    // ××™×Ÿ ×§×˜×’×•×¨×™×•×ª - ×¨×©×™××” ×©×˜×•×—×”
    const topics = grouped.get('×›×œ×œ×™')!;
    output += '×”× ×•×©××™× ×”×–××™× ×™× (×”×©×ª××© ×‘××–×”×” ×”×× ×’×œ×™ ×‘-topic_id):\n\n';
    
    output += '| × ×•×©× | ××–×”×” (topic_id) | ×ª×™××•×¨ ×”×©×“×•×ª |\n';
    output += '|------|----------------|-------------|\n';
    
    for (const topic of topics) {
      const fieldsDesc = topic.response_schema 
        ? Object.entries(topic.response_schema.fields).map(([k, v]) => `${k}=${v}`).join('; ')
        : '×œ× ×–××™×Ÿ';
      
      output += `| ${topic.description_he} | \`${topic.id}\` | ${fieldsDesc} |\n`;
    }
  } else {
    // ×™×© ×§×˜×’×•×¨×™×•×ª
    for (const [category, topics] of grouped) {
      output += `### ${category}\n\n`;
      for (const topic of topics) {
        output += `- **${topic.description_he}** (\`${topic.id}\`)\n`;
        
        // ×”×•×¡×£ ×ª×™××•×¨ ×©×“×•×ª ×× ×§×™×™×
        if (topic.response_schema) {
          output += `  - ${topic.response_schema.description}\n`;
          output += `  - ×©×“×•×ª: ${Object.entries(topic.response_schema.fields)
            .map(([k, v]) => `\`${k}\` (${v})`)
            .join(', ')}\n`;
        }
        output += '\n';
      }
    }
  }
  
  output += '\nğŸ’¡ **×˜×™×¤**: ×›×©××ª×” ××§×‘×œ × ×ª×•× ×™×, ×”×©×ª××© ×‘×ª×™××•×¨ ×”×©×“×•×ª ×›×“×™ ×œ×”×‘×™×Ÿ ××ª ×”××©××¢×•×ª ×”××“×•×™×§×ª ×©×œ ×›×œ ×¢×¨×š.\n';
  
  return output;
}

function getUniqueDepartments(employees: Employee[]): string[] {
  return [...new Set(employees.map(e => e.department))].sort();
}

function getUniqueDivisions(employees: Employee[]): string[] {
  return [...new Set(employees.map(e => e.division))].sort();
}

function chunkArray<T>(array: T[], size: number): T[][] {
  const chunks: T[][] = [];
  for (let i = 0; i < array.length; i += size) {
    chunks.push(array.slice(i, i + size));
  }
  return chunks;
}

// =====================================
// 5. Angular Service - ××™××•×© ××œ×
// =====================================

import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { BehaviorSubject, Observable, firstValueFrom } from 'rxjs';
import OpenAI from 'openai';

@Injectable({
  providedIn: 'root'
})
export class CohereHRChatService {
  private openai: OpenAI;
  private messages: ChatMessage[] = [];
  private messagesSubject = new BehaviorSubject<ChatMessage[]>([]);
  
  // Cache ×œ× ×ª×•× ×™× ×©×œ× ××©×ª× ×™×
  private user!: User;
  private employees: Employee[] = [];
  private topics: Topic[] = [];
  private systems: SystemLink[] = [];
  
  // Cache ×œ×ª×•×¦××•×ª ×©×™×¨×•×ª×™× (××•×¤×¦×™×•× ×œ×™)
  private serviceCache = new Map<string, any>();
  
  constructor(private http: HttpClient) {
    this.openai = new OpenAI({
      baseURL: 'https://api.cohere.com/v1',
      apiKey: 'YOUR_COHERE_API_KEY',
      dangerouslyAllowBrowser: true // ×¨×§ ×œ×¤×™×ª×•×— - ×‘×¤×¨×•×“×§×©×Ÿ ×“×¨×š Backend!
    });
  }

  // =====================================
  // ××ª×—×•×œ - ×˜×¢×™× ×ª ×›×œ ×”× ×ª×•× ×™×
  // =====================================
  
  async initialize(): Promise<void> {
    try {
      // ×˜×¢×Ÿ ××ª ×›×œ ×”× ×ª×•× ×™× ×‘××§×‘×™×œ
      const [user, employees, topics, systems] = await Promise.all([
        this.loadCurrentUser(),
        this.loadAuthorizedEmployees(),
        this.loadAvailableTopics(),
        this.loadSystemLinks()
      ]);
      
      this.user = user;
      this.employees = employees;
      this.topics = topics;
      this.systems = systems;
      
      // ×¦×•×¨ system prompt
      const systemPrompt = createSystemPrompt(
        this.user,
        this.employees,
        this.topics,
        this.systems
      );
      
      // ×”×•×¡×£ system message
      this.messages = [{
        role: 'system',
        content: systemPrompt
      }];
      
      console.log('âœ… Chat initialized successfully');
      console.log(`ğŸ“Š ${employees.length} employees, ${topics.length} topics, ${systems.length} systems`);
      
    } catch (error) {
      console.error('âŒ Failed to initialize chat:', error);
      throw error;
    }
  }

  // =====================================
  // ×©×œ×™×—×ª ×”×•×“×¢×” - ×”×œ×‘ ×©×œ ×”××¢×¨×›×ª
  // =====================================
  
  async sendMessage(userMessage: string): Promise<string> {
    // ×”×•×¡×£ ×”×•×“×¢×ª ××©×ª××©
    this.addMessage({
      role: 'user',
      content: userMessage
    });
    
    let finalResponse = '';
    let iterationCount = 0;
    const maxIterations = 10; // ××’×‘×œ×” ×œ×× ×™×¢×ª ×œ×•×œ××•×ª ××™× ×¡×•×¤×™×•×ª
    
    while (iterationCount < maxIterations) {
      iterationCount++;
      
      try {
        // ×”×›×Ÿ Documents - ×¨×§ ×œ×™× ×§×™× ×œ×›×œ ×§×¨×™××”
        const documents = prepareSystemLinksAsDocuments(this.systems);
        
        // ×§×¨×™××” ×œ-Cohere ×¢× Documents
        const response = await this.openai.chat.completions.create({
          model: 'command-r-03-2025',
          messages: this.messages as any,
          tools: createOptimizedTools(this.topics),
          tool_choice: 'auto',
          temperature: 0.3, // × ××•×š ×™×•×ª×¨ ×œ×“×™×•×§ ×’×‘×•×” ×™×•×ª×¨
          max_tokens: 2000,
          // â­ ×–×” ×”×—×œ×§ ×”×—×©×•×‘ - Documents!
          // @ts-ignore - OpenAI SDK ×œ× ×ª××™×“ ×ª×•××š ×‘×–×” ××‘×œ Cohere ×›×Ÿ
          documents: documents
        });
        
        const choice = response.choices[0];
        
        // ×”××•×“×œ ×¨×•×¦×” ×œ×§×¨×•× ×œ-tools
        if (choice.finish_reason === 'tool_calls' && choice.message.tool_calls) {
          console.log(`ğŸ”§ Tool calls requested (iteration ${iterationCount}):`, 
            choice.message.tool_calls.map(tc => tc.function.name));
          
          // ×”×•×¡×£ ××ª ×”×•×“×¢×ª ×”××•×“×œ
          this.addMessage(choice.message as ChatMessage);
          
          // ×‘×¦×¢ ××ª ×›×œ ×”-tool calls ×‘××§×‘×™×œ
          const toolResults = await Promise.all(
            choice.message.tool_calls.map(toolCall => this.executeToolCall(toolCall))
          );
          
          // ×”×•×¡×£ ××ª ×”×ª×•×¦××•×ª
          for (let i = 0; i < choice.message.tool_calls.length; i++) {
            this.addMessage({
              role: 'tool',
              content: JSON.stringify(toolResults[i], null, 2),
              tool_call_id: choice.message.tool_calls[i].id,
              name: choice.message.tool_calls[i].function.name
            });
          }
          
          // ×”××©×š ×œ×œ×•×œ××” - ×”××•×“×œ ×™×§×‘×œ ××ª ×”×ª×•×¦××•×ª ×•×™×—×œ×™×˜ ××” ×”×œ××”
          continue;
        }
        
        // ×”××•×“×œ ×¡×™×™× - ×™×© ×ª×©×•×‘×” ×¡×•×¤×™×ª
        if (choice.message.content) {
          finalResponse = choice.message.content;
          this.addMessage({
            role: 'assistant',
            content: finalResponse
          });
          
          console.log(`âœ… Final response received (${iterationCount} iterations)`);
          break;
        }
        
        // ×× ××™×Ÿ content ×•××™×Ÿ tool_calls - ××©×”×• ×œ× ×‘×¡×“×¨
        console.warn('âš ï¸ No content or tool_calls in response');
        break;
        
      } catch (error) {
        console.error('âŒ Error in chat completion:', error);
        throw error;
      }
    }
    
    if (iterationCount >= maxIterations) {
      console.warn('âš ï¸ Max iterations reached');
      finalResponse = '××¦×˜×¢×¨, ×”×’×¢×ª×™ ×œ××’×‘×œ×ª ×”×¤×¢×•×œ×•×ª. ×× × × ×¡×” ×œ× ×¡×— ××ª ×”×©××œ×” ××—×“×©.';
    }
    
    this.messagesSubject.next([...this.messages]);
    return finalResponse;
  }

  // =====================================
  // ×‘×™×¦×•×¢ Tool Calls
  // =====================================
  
  private async executeToolCall(toolCall: ToolCall): Promise<any> {
    const { name, arguments: argsStr } = toolCall.function;
    
    try {
      const args = JSON.parse(argsStr);
      console.log(`ğŸ”§ Executing ${name} with args:`, args);
      
      switch (name) {
        case 'get_employee_data':
          return await this.getEmployeeData(
            args.employee_numbers,
            args.topic_id,
            args.reasoning
          );
        
        case 'search_employees':
          return this.searchEmployees(args);
        
        default:
          return {
            error: true,
            message: `Unknown tool: ${name}`
          };
      }
    } catch (error) {
      console.error(`âŒ Error executing ${name}:`, error);
      return {
        error: true,
        message: `×©×’×™××” ×‘×‘×™×¦×•×¢ ${name}: ${error}`
      };
    }
  }

  // =====================================
  // Tool 1: get_employee_data
  // =====================================
  
  private async getEmployeeData(
    employeeNumbers: string,
    topicId: string,
    reasoning?: string
  ): Promise<any> {
    console.log(`ğŸ“Š Getting data for: ${employeeNumbers}, topic: ${topicId}`);
    if (reasoning) console.log(`ğŸ’­ Reasoning: ${reasoning}`);
    
    // 1. Validate topic exists
    const topic = this.topics.find(t => t.id === topicId);
    if (!topic) {
      return {
        error: true,
        message: `×”× ×•×©× "${topicId}" ×œ× ×§×™×™× ×‘×¨×©×™××ª ×”× ×•×©××™× ×”×–××™× ×™×`,
        available_topics: this.topics.map(t => ({ id: t.id, description: t.description_he }))
      };
    }
    
    // 2. Validate employee numbers (××œ× ×× ×–×” "*")
    if (employeeNumbers !== '*') {
      const numbers = employeeNumbers.split(',').map(n => n.trim());
      const invalidNumbers = numbers.filter(num => 
        !this.employees.find(e => e.number === num)
      );
      
      if (invalidNumbers.length > 0) {
        return {
          error: true,
          message: `××¡×¤×¨×™ ×¢×•×‘×“×™× ×œ× ×ª×§×™× ×™× ××• ×œ× ××•×¨×©×™×: ${invalidNumbers.join(', ')}`,
          hint: '×”×©×ª××© ×‘-search_employees ×›×“×™ ×œ××¦×•× ××ª ××¡×¤×¨ ×”×¢×•×‘×“ ×”× ×›×•×Ÿ'
        };
      }
    }
    
    // 3. Check cache
    const cacheKey = `${employeeNumbers}_${topicId}`;
    if (this.serviceCache.has(cacheKey)) {
      console.log('ğŸ“¦ Returning cached result');
      return this.serviceCache.get(cacheKey);
    }
    
    // 4. Call the generic service
    try {
      const rawResult = await this.callGenericService(employeeNumbers, topicId);
      
      // 5. â­ ×”××¨×” ×œ×¤×•×¨××˜ ××•×¤×˜×™××œ×™ ×œ××•×“×œ
      const formattedResult = this.formatDataForModel(rawResult, topicId, employeeNumbers);
      
      // Cache the result
      this.serviceCache.set(cacheKey, formattedResult);
      
      return formattedResult;
      
    } catch (error) {
      return {
        error: true,
        message: '×©×’×™××” ×‘×§×‘×œ×ª ×”××™×“×¢ ××”×©×¨×ª',
        details: error
      };
    }
  }

  // =====================================
  // ×¤×•×¨××˜ ×—×›× ×©×œ ×”× ×ª×•× ×™× ×œ××•×“×œ
  // =====================================
  
  private formatDataForModel(
    rawData: any,
    topicId: string,
    employeeNumbers: string
  ): any {
    const topic = this.topics.find(t => t.id === topicId);
    
    // ×‘×“×•×§ ×× ×–×” × ×ª×•× ×™× ×¢×œ ×”×¨×‘×” ×¢×•×‘×“×™×
    const isMultipleEmployees = employeeNumbers === '*' || employeeNumbers.includes(',');
    const employeeCount = Array.isArray(rawData) ? rawData.length : 1;
    
    // ×”×—×œ×˜×”: CSV ××• JSON?
    const useCSV = this.shouldUseCSV(rawData, employeeCount);
    
    // â­ ×”×›×Ÿ ×ª×™××•×¨ ×©×“×•×ª ××”×¡×›××”
    const schemaInfo = topic?.response_schema 
      ? this.formatSchemaDescription(topic.response_schema)
      : '';
    
    if (useCSV) {
      // ×”××¨×” ×œ-CSV ×œ× ×ª×•× ×™× ×˜×‘×œ××™×™× ×’×“×•×œ×™×
      const csvData = this.convertToCSV(rawData);
      
      return {
        success: true,
        topic: topic?.description_he,
        topic_id: topicId,
        employee_numbers: employeeNumbers,
        format: 'csv',
        data_count: employeeCount,
        data: csvData,
        schema_info: schemaInfo,  // â­ ×”×•×¡×¤×”!
        instructions: `
×”× ×ª×•× ×™× ××•×¦×’×™× ×‘×¤×•×¨××˜ CSV ×œ×§×¨×™××” ×§×œ×”.
${schemaInfo ? `\nğŸ“‹ **××©××¢×•×ª ×”×©×“×•×ª:**\n${schemaInfo}\n` : ''}
**×”×•×¨××•×ª:**
- ×©×•×¨×” ×¨××©×•× ×”: ×›×•×ª×¨×•×ª ×”×¢××•×“×•×ª
- ×©×•×¨×•×ª × ×•×¡×¤×•×ª: × ×ª×•× ×™ ×¢×•×‘×“×™×
- × ×ª×— ××ª ×”× ×ª×•× ×™× ×•×”×¦×’ ×‘×¦×•×¨×” ×‘×¨×•×¨×” ×œ××©×ª××©
- ×× ×¦×¨×™×š ×œ×¡×¤×•×¨/×œ×¡× ×Ÿ - ×¢×‘×•×¨ ×¢×œ ×›×œ ×”×©×•×¨×•×ª
- ×”×©×ª××© ×‘×ª×™××•×¨ ×”×©×“×•×ª ×›×“×™ ×œ×”×‘×™×Ÿ ××ª ×”××©××¢×•×ª ×”××“×•×™×§×ª
        `.trim()
      };
    } else {
      // ×”×©××¨ JSON ×œ× ×ª×•× ×™× ××•×¨×›×‘×™× ××• ××¢×˜×™×
      return {
        success: true,
        topic: topic?.description_he,
        topic_id: topicId,
        employee_numbers: employeeNumbers,
        format: 'json',
        data_count: employeeCount,
        data: rawData,
        schema_info: schemaInfo,  // â­ ×”×•×¡×¤×”!
        instructions: `
×”× ×ª×•× ×™× ××•×¦×’×™× ×‘×¤×•×¨××˜ JSON.
${schemaInfo ? `\nğŸ“‹ **××©××¢×•×ª ×”×©×“×•×ª:**\n${schemaInfo}\n` : ''}
**×”×•×¨××•×ª:**
- × ×ª×— ××ª ×”××‘× ×” ×•×”×¦×’ ×‘×¦×•×¨×” ×‘×¨×•×¨×” ×œ××©×ª××©
- ×©×™× ×œ×‘ ×œ×©×“×•×ª ××§×•× × ×™× ×× ×™×©
- ×”×©×ª××© ×‘×ª×™××•×¨ ×”×©×“×•×ª ×›×“×™ ×œ×”×‘×™×Ÿ ××ª ×”××©××¢×•×ª ×”××“×•×™×§×ª
        `.trim()
      };
    }
  }

  // =====================================
  // ×¤×•×¨××˜ ×ª×™××•×¨ ×”×¡×›××”
  // =====================================
  
  private formatSchemaDescription(schema: Topic['response_schema']): string {
    if (!schema || !schema.fields) return '';
    
    let output = '';
    
    if (schema.description) {
      output += `${schema.description}\n\n`;
    }
    
    output += '×©×“×•×ª:\n';
    for (const [fieldName, fieldDesc] of Object.entries(schema.fields)) {
      output += `- **${fieldName}**: ${fieldDesc}\n`;
    }
    
    if (schema.example) {
      output += `\n×“×•×’××”:\n\`\`\`json\n${JSON.stringify(schema.example, null, 2)}\n\`\`\``;
    }
    
    return output;
  }

  // =====================================
  // ×”×—×œ×˜×” ××•×˜×•××˜×™×ª: CSV ××• JSON?
  // =====================================
  
  private shouldUseCSV(data: any, employeeCount: number): boolean {
    // ×× ×–×” ×œ× array - ×ª××™×“ JSON
    if (!Array.isArray(data)) {
      return false;
    }
    
    // ×× ×™×© ×¤×—×•×ª ×-5 ×¨×©×•××•×ª - JSON ×‘×¡×“×¨
    if (employeeCount < 5) {
      return false;
    }
    
    // ×‘×“×•×§ ×× ×”× ×ª×•× ×™× "×©×˜×•×—×™×" (×˜×‘×œ××™×™×)
    const firstItem = data[0];
    if (!firstItem || typeof firstItem !== 'object') {
      return false;
    }
    
    // ×‘×“×•×§ ×× ×™×© nested objects/arrays
    const hasNesting = Object.values(firstItem).some(value => 
      typeof value === 'object' && value !== null
    );
    
    // ×× ×™×© ×§×™× ×•×Ÿ - JSON ×¢×“×™×£
    if (hasNesting) {
      return false;
    }
    
    // ×× ×™×© ×”×¨×‘×” ×¨×©×•××•×ª (10+) ×•× ×ª×•× ×™× ×©×˜×•×—×™× - CSV!
    return employeeCount >= 10;
  }

  // =====================================
  // ×”××¨×” ×œ-CSV
  // =====================================
  
  private convertToCSV(data: any[]): string {
    if (!Array.isArray(data) || data.length === 0) {
      return '';
    }
    
    // ×§×‘×œ ××ª ×›×œ ×”××¤×ª×—×•×ª (headers)
    const headers = Object.keys(data[0]);
    
    // ×‘× ×” CSV
    const csvRows = [];
    
    // ×©×•×¨×ª headers
    csvRows.push(headers.join(','));
    
    // ×©×•×¨×•×ª × ×ª×•× ×™×
    for (const row of data) {
      const values = headers.map(header => {
        const value = row[header];
        
        // ×˜×™×¤×•×œ ×‘××—×¨×•×–×•×ª ×©×™×© ×‘×”×Ÿ ×¤×¡×™×§ - ×¢×˜×•×£ ×‘××¨×›××•×ª
        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
          return `"${value.replace(/"/g, '""')}"`;
        }
        
        // null/undefined â†’ ×¨×™×§
        if (value == null) {
          return '';
        }
        
        return value;
      });
      
      csvRows.push(values.join(','));
    }
    
    return csvRows.join('\n');
  }

  // =====================================
  // Tool 2: search_employees
  // =====================================
  
  private searchEmployees(criteria: {
    name?: string;
    department?: string;
    division?: string;
    branch?: string;
    role?: string;
  }): any {
    console.log('ğŸ” Searching employees with criteria:', criteria);
    
    let results = [...this.employees];
    
    // Filter by name (partial match, case insensitive)
    if (criteria.name) {
      const searchName = criteria.name.toLowerCase();
      results = results.filter(e => 
        e.name.toLowerCase().includes(searchName) ||
        (e.nickname && e.nickname.toLowerCase().includes(searchName))
      );
    }
    
    // Filter by department
    if (criteria.department) {
      results = results.filter(e => 
        e.department.toLowerCase() === criteria.department!.toLowerCase()
      );
    }
    
    // Filter by division
    if (criteria.division) {
      results = results.filter(e => 
        e.division.toLowerCase() === criteria.division!.toLowerCase()
      );
    }
    
    // Filter by branch
    if (criteria.branch) {
      results = results.filter(e => 
        e.branch.toLowerCase() === criteria.branch!.toLowerCase()
      );
    }
    
    // Filter by role
    if (criteria.role) {
      results = results.filter(e => 
        e.role.toLowerCase().includes(criteria.role!.toLowerCase())
      );
    }
    
    console.log(`âœ… Found ${results.length} employees`);
    
    return {
      success: true,
      count: results.length,
      employees: results.map(e => ({
        number: e.number,
        name: e.name,
        nickname: e.nickname,
        department: e.department,
        division: e.division,
        branch: e.branch,
        role: e.role
      }))
    };
  }

  // =====================================
  // Tool 3: get_system_link
  // =====================================
  
  private getSystemLink(query: string): any {
    console.log(`ğŸ”— Searching for system link: ${query}`);
    
    const searchQuery = query.toLowerCase();
    
    // ×—×¤×© ×‘××¢×¨×›×•×ª ×œ×¤×™ ×©× ××• ×ª×’×™×•×ª
    const results = this.systems.filter(system => 
      system.name.toLowerCase().includes(searchQuery) ||
      system.tags.some(tag => tag.toLowerCase().includes(searchQuery))
    );
    
    if (results.length === 0) {
      return {
        success: false,
        message: `×œ× × ××¦××” ××¢×¨×›×ª ×¢×‘×•×¨ "${query}"`,
        available_systems: this.systems.map(s => ({
          name: s.name,
          tags: s.tags
        }))
      };
    }
    
    return {
      success: true,
      count: results.length,
      systems: results.map(s => ({
        name: s.name,
        url: s.url,
        tags: s.tags
      }))
    };
  }

  // =====================================
  // ×§×¨×™××” ×œ×©×™×¨×•×ª ×”×’× ×¨×™ (Backend)
  // =====================================
  
  private async callGenericService(
    employeeNumbers: string,
    topicId: string
  ): Promise<any> {
    // ×–×•×”×™ ×”×§×¨×™××” ×‘×¤×•×¢×œ ×œ×©×¨×ª ×©×œ×š
    const url = '/api/hr/employee-data'; // ×”×ª×× ×œ× ×ª×™×‘ ×©×œ×š
    
    const response = await firstValueFrom(
      this.http.post(url, {
        employee_numbers: employeeNumbers,
        topic_id: topicId
      })
    );
    
    return response;
  }

  // =====================================
  // ×˜×¢×™× ×ª × ×ª×•× ×™× ×¨××©×•× ×™×™×
  // =====================================
  
  private async loadCurrentUser(): Promise<User> {
    return firstValueFrom(this.http.get<User>('/api/auth/current-user'));
  }
  
  private async loadAuthorizedEmployees(): Promise<Employee[]> {
    return firstValueFrom(this.http.get<Employee[]>('/api/hr/authorized-employees'));
  }
  
  private async loadAvailableTopics(): Promise<Topic[]> {
    return firstValueFrom(this.http.get<Topic[]>('/api/hr/topics'));
  }
  
  private async loadSystemLinks(): Promise<SystemLink[]> {
    return firstValueFrom(this.http.get<SystemLink[]>('/api/systems/links'));
  }

  // =====================================
  // × ×™×”×•×œ ×”×•×“×¢×•×ª
  // =====================================
  
  private addMessage(message: ChatMessage): void {
    this.messages.push(message);
  }
  
  getMessages(): Observable<ChatMessage[]> {
    return this.messagesSubject.asObservable();
  }
  
  clearHistory(): void {
    // ×©××•×¨ ×¨×§ ××ª system message
    this.messages = [this.messages[0]];
    this.messagesSubject.next([...this.messages]);
    this.serviceCache.clear();
  }
  
  // =====================================
  // Streaming (××•×¤×¦×™×•× ×œ×™)
  // =====================================
  
  async sendMessageStreaming(
    userMessage: string,
    onChunk: (chunk: string) => void
  ): Promise<void> {
    this.addMessage({
      role: 'user',
      content: userMessage
    });
    
    const stream = await this.openai.chat.completions.create({
      model: 'command-r-03-2025',
      messages: this.messages as any,
      tools: createOptimizedTools(this.topics),
      stream: true,
      temperature: 0.3
    });
    
    let fullResponse = '';
    
    for await (const chunk of stream) {
      const delta = chunk.choices[0]?.delta?.content;
      if (delta) {
        fullResponse += delta;
        onChunk(delta);
      }
    }
    
    this.addMessage({
      role: 'assistant',
      content: fullResponse
    });
    
    this.messagesSubject.next([...this.messages]);
  }
}

// =====================================
// 6. ×“×•×’××ª ×©×™××•×© ×‘×§×•××¤×•× × ×˜×”
// =====================================

/*
@Component({
  selector: 'app-hr-chat',
  template: `
    <div class="chat-container">
      <div class="messages">
        <div *ngFor="let msg of messages$ | async" 
             [class]="'message ' + msg.role">
          <div [innerHTML]="formatMessage(msg.content)"></div>
        </div>
      </div>
      
      <div class="input-area">
        <input 
          [(ngModel)]="userInput"
          (keyup.enter)="sendMessage()"
          placeholder="×©××œ ×©××œ×” ×¢×œ ×”×¢×•×‘×“×™×..."
          [disabled]="isLoading"
        />
        <button 
          (click)="sendMessage()"
          [disabled]="isLoading || !userInput"
        >
          ×©×œ×—
        </button>
      </div>
      
      <div *ngIf="isLoading" class="loading">
        ×”××•×“×œ ×¢×•×‘×“ ×¢×œ ×”×ª×©×•×‘×”...
      </div>
    </div>
  `
})
export class HRChatComponent implements OnInit {
  messages$: Observable<ChatMessage[]>;
  userInput = '';
  isLoading = false;
  
  constructor(private chatService: CohereHRChatService) {
    this.messages$ = this.chatService.getMessages();
  }
  
  async ngOnInit() {
    await this.chatService.initialize();
  }
  
  async sendMessage() {
    if (!this.userInput.trim()) return;
    
    this.isLoading = true;
    const message = this.userInput;
    this.userInput = '';
    
    try {
      await this.chatService.sendMessage(message);
    } catch (error) {
      console.error('Error:', error);
    } finally {
      this.isLoading = false;
    }
  }
  
  formatMessage(content: string): string {
    // ×”××¨ Markdown ×œ-HTML
    return marked.parse(content);
  }
}
*/

// =====================================
// 7. ×˜×™×¤×™× ×œ××•×¤×˜×™××™×–×¦×™×”
// =====================================

/*
ğŸ’¡ PERFORMANCE TIPS:

1. **CSV vs JSON - ×”××¡×˜×¨×˜×’×™×”:**
   âœ… CSV ××•×˜×•××˜×™ ×›××©×¨:
   - 10+ ×¢×•×‘×“×™×
   - × ×ª×•× ×™× ×©×˜×•×—×™× (×‘×œ×™ nested objects)
   - ×©×“×•×ª ×§×‘×•×¢×™×
   
   âœ… JSON ×›××©×¨:
   - ×¤×—×•×ª ×-10 ×¢×•×‘×“×™×
   - × ×ª×•× ×™× ××•×¨×›×‘×™× (×§×•×¨×¡×™×, ×”×™×¡×˜×•×¨×™×”)
   - ××‘× ×” ××©×ª× ×”
   
   ğŸ“Š ×—×™×¡×›×•×Ÿ ×‘-Tokens:
   - 100 ×¢×•×‘×“×™× ×‘-JSON: ~15,000 tokens
   - 100 ×¢×•×‘×“×™× ×‘-CSV: ~5,000 tokens
   - ×—×™×¡×›×•×Ÿ ×©×œ 66%! ğŸ‰

2. **×“×•×’×××•×ª ×œ×¤×•×¨××˜×™×:**

   JSON (×¢×•×‘×“ ××—×“ ××• × ×ª×•× ×™× ××•×¨×›×‘×™×):
   ```json
   {
     "employee_number": "12345",
     "name": "×“×•×“ ×œ×•×™",
     "courses": [
       {"name": "× ×™×”×•×œ", "date": "2024-01", "hours": 40},
       {"name": "Excel", "date": "2024-03", "hours": 20}
     ]
   }
   ```
   
   CSV (×”×¨×‘×” ×¢×•×‘×“×™×, × ×ª×•× ×™× ×¤×©×•×˜×™×):
   ```csv
   employee_number,name,vacation_days,used_days,remaining_days
   12345,×“×•×“ ×œ×•×™,25,10,15
   67890,××©×” ×›×”×Ÿ,30,5,25
   11111,×©×¨×” ×™×©×¨××œ×™,28,12,16
   ...
   ```

3. **Documents vs Context:**
   âœ… Documents (100-200 ×œ×™× ×§×™×):
   - ×œ× ×ª×•×¤×¡×™× ××§×•× ×‘-context window
   - Cohere ×¢×•×©×” ×—×™×¤×•×© ×¡×× ×˜×™ ××•×˜×•××˜×™
   - ×¨×§ ×”×œ×™× ×§×™× ×”×¨×œ×•×•× ×˜×™×™× "××•×¤×™×¢×™×" ×œ××•×“×œ
   
   âŒ System Prompt (100-200 ×œ×™× ×§×™×):
   - ×ª×•×¤×¡ 20,000+ tokens ××”-context
   - ×¤×—×•×ª ××§×•× ×œ×©×™×—×” ×•×œ×”×™×¡×˜×•×¨×™×”
   - ××™×Ÿ ×—×™×¤×•×© ×—×›×

4. **××™×š Documents ×¢×•×‘×“:**
   - ×”××©×ª××© ×©×•××œ: "×ª×Ÿ ×œ×™ ×§×™×©×•×¨ ×œ×©×¢×•×Ÿ × ×•×›×—×•×ª"
   - Cohere ××—×¤×© ××•×˜×•××˜×™×ª ×‘-Documents: "×©×¢×•×Ÿ", "× ×•×›×—×•×ª", "attendance"
   - ××—×–×™×¨ ×¨×§ ××ª ×”×œ×™× ×§×™× ×”×¨×œ×•×•× ×˜×™×™× ×œ××•×“×œ
   - ×”××•×“×œ ××©×ª××© ×‘×”× ×œ×‘× ×™×™×ª ×”×ª×©×•×‘×”

5. **Context Management ×¢× 50+ × ×•×©××™×:**
   - ×× ×”-system prompt ××¨×•×š ××“×™ (>8000 tokens), ×©×§×•×œ:
     * ×œ×©×œ×•×— ×¨×§ ××ª ×”×§×˜×’×•×¨×™×•×ª ×‘×¤×¢× ×”×¨××©×•× ×”
     * ×œ×”×•×¡×™×£ × ×•×©××™× ×¡×¤×¦×™×¤×™×™× ×¨×§ ×›×©×”××©×ª××© ×©×•××œ ×¢×œ×™×”×
   
6. **Caching ×—×›×:**
   - ×©××•×¨ ×ª×•×¦××•×ª ×œ×©××™×œ×ª×•×ª ×¢×œ "*" (×›×œ ×”×¢×•×‘×“×™×)
   - × ×§×” cache ××—×¨×™ 5 ×“×§×•×ª
   - ×”×©×ª××© ×‘-LRU cache ×× ×™×© ×”×¨×‘×” ×©××™×œ×ª×•×ª

7. **Parallel Processing:**
   - ×‘×¦×¢ tool calls ×‘××§×‘×™×œ (Promise.all)
   - ×× ×™×© ×›××” ×¢×•×‘×“×™× - ×§×¨× ×œ×›×•×œ× ×‘××§×‘×™×œ

8. **Error Recovery:**
   - ×× ×”××•×“×œ ×‘×•×—×¨ topic_id ×©×’×•×™, ×”×—×–×¨ ×œ×• ×¨×©×™××” ×©×œ × ×•×©××™× ×“×•××™×
   - ×× search_employees ××—×–×™×¨ ×™×•×ª×¨ ×-10 ×ª×•×¦××•×ª, ×‘×§×© ××”××•×“×œ ×œ×¦××¦×

9. **Monitoring:**
   - ×¢×§×•×‘ ××—×¨×™ ×›××” iterations ×œ×•×§×— ×›×œ ×©××œ×”
   - ×¢×§×•×‘ ××—×¨×™ topic_id ×©×’×•×™×™× - ××•×œ×™ ×¦×¨×™×š ×œ×©×¤×¨ ××ª ×”-prompt
   - ×‘×“×•×§ ×× Documents ××—×–×™×¨ ××ª ×”×œ×™× ×§×™× ×”× ×›×•× ×™×
   - ×¢×§×•×‘ ××—×¨×™ ×©×™××•×© ×‘-CSV vs JSON - ×”×× ×”×”×—×œ×˜×” × ×›×•× ×”?

10. **Testing:**
    - ×‘×“×•×§ ×¢× ×©××œ×•×ª ××•×¨×›×‘×•×ª:
      * "×›××” ×¢×•×‘×“×™× ××”×›×œ×›×œ×” ×•×”××›×™×¨×•×ª ×‘×™×—×“ ×™×© ×œ×”× ×™×•×ª×¨ ×-50 ×™××™ ×—×•×¤×© ×•×§×•×¨×¡ ×‘× ×™×”×•×œ?"
      * ×–×” ×™×“×¨×•×©: search x2, get_employee_data x2, analysis
    - ×‘×“×•×§ ×©××œ×•×ª ×¢×œ ×œ×™× ×§×™×:
      * "×ª×Ÿ ×œ×™ ×§×™×©×•×¨ ×œ××©×›×•×¨×•×ª ×•×œ×©×¢×•×Ÿ × ×•×›×—×•×ª"
      * ×”××•×“×œ ×¦×¨×™×š ×œ××¦×•× ×©× ×™ ×œ×™× ×§×™× ××”-Documents
    - ×‘×“×•×§ ×¢× ×›×œ ×”×¢×•×‘×“×™×:
      * "×œ×›××” ×¢×•×‘×“×™× ×™×© ×™×•×ª×¨ ×-50 ×™××™ ×—×•×¤×©?"
      * ×¦×¨×™×š ×œ×§×‘×œ CSV ×¢× ×××•×ª ×©×•×¨×•×ª ×•×œ× ×ª×—

11. **Documents Best Practices:**
    - ×©××•×¨ ××ª ×”-text ×¤×©×•×˜ ×•×‘×¨×•×¨
    - ×›×œ×•×œ ××™×œ×•×ª ×—×™×¤×•×© ×•×¡×™× ×•× ×™××™× ×‘×ª×’×™×•×ª
    - ×”×©×ª××© ×‘-metadata ×× ×¦×¨×™×š ×œ×¡× ×Ÿ ×××•×—×¨ ×™×•×ª×¨
    - ×›×œ document ×¦×¨×™×š ×œ×”×™×•×ª ×¢×¦×××™ (×œ× ×œ×”×¤× ×•×ª ×œ-documents ××—×¨×™×)
*/

// =====================================
// 8. ×“×•×’×××•×ª ×œ×©×™××•×© ×¢× Documents
// =====================================

/*
×“×•×’××” 1: ×©××œ×” ×¤×©×•×˜×” ×¢×œ ×œ×™× ×§
ğŸ‘¤: "×ª×Ÿ ×œ×™ ×§×™×©×•×¨ ×œ×©×¢×•×Ÿ × ×•×›×—×•×ª"

ğŸ”„ ××” ×§×•×¨×” ×××—×•×¨×™ ×”×§×œ×¢×™×:
1. Cohere ××§×‘×œ ××ª ×”×©××œ×” + 200 documents
2. ××—×¤×© ×‘××™×œ×™×: "×©×¢×•×Ÿ", "× ×•×›×—×•×ª"
3. ××•×¦×: "××¢×¨×›×ª ×©×¢×•×Ÿ × ×•×›×—×•×ª, ×§×™×©×•×¨: https://..."
4. ××—×–×™×¨ ×œ××•×“×œ ×¨×§ ××ª ×”-documents ×”×¨×œ×•×•× ×˜×™×™×
5. ×”××•×“×œ ××©×ª××© ×‘×”×: "×‘×˜×—! ×”× ×” ×”×§×™×©×•×¨..."

ğŸ¤– ×ª×©×•×‘×”: "×‘×˜×—! ×”× ×” ×”×§×™×©×•×¨ ×œ×©×¢×•×Ÿ × ×•×›×—×•×ª: [×œ×—×¥ ×›××Ÿ](https://attendance.com)"

---

×“×•×’××” 2: ×©××œ×” ××•×¨×›×‘×ª
ğŸ‘¤: "×›××” ×™××™ ×—×•×¤×© ×™×© ×œ×“×•×“ ×œ×•×™ ×•×ª×Ÿ ×œ×™ ×’× ×§×™×©×•×¨ ×œ××©×›×•×¨×•×ª"

ğŸ”„ ×ª×”×œ×™×š:
1. search_employees(name: "×“×•×“ ×œ×•×™")
2. get_employee_data(employee_numbers: "12345", topic_id: "vacation")
3. Cohere ××—×¤×© ×‘-Documents: "××©×›×•×¨×•×ª", "payroll"
4. ××•×¦× ××ª ×”×œ×™× ×§ ×”×¨×œ×•×•× ×˜×™

ğŸ¤– ×ª×©×•×‘×”: 
"×œ×“×•×“ ×œ×•×™ ×™×© 25 ×™××™ ×—×•×¤×©.
×”× ×” ×”×§×™×©×•×¨ ×œ××¢×¨×›×ª ×”××©×›×•×¨×•×ª: [××¢×¨×›×ª ××©×›×•×¨×•×ª](https://payroll.com)"

---

×“×•×’××” 3: ×—×™×¤×•×© ×œ× ××“×•×™×§
ğŸ‘¤: "××™×¤×” ×× ×™ ×¨×•××” ××ª ×”×ª×œ×•×©×™×?"

ğŸ”„ Cohere ××—×¤×©:
- "×ª×œ×•×©×™×", "××©×›×•×¨×ª", "×©×›×¨"
- ××•×¦×: "××¢×¨×›×ª ××©×›×•×¨×•×ª - ×ª×œ×•×© ×©×›×¨, ×©×›×¨"

ğŸ¤– ×ª×©×•×‘×”: "××ª ×”×ª×œ×•×©×™× ××¤×©×¨ ×œ×¨××•×ª ×‘××¢×¨×›×ª ×”××©×›×•×¨×•×ª: [×œ×—×¥ ×›××Ÿ](https://payroll.com)"
*/